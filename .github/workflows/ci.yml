name: Run tests, publish docker image

on:
  push:
    branches:
      - master
    paths-ignore:
      - "swagger/**"
  pull_request:
    paths-ignore:
      - "swagger/**"

env:
  IMAGE_NAME: workbench-server
  DOCKER_BUILDKIT: 1
  REGISTRY: ghcr.io
  TEST_BUCKETS: 16

jobs:
  # Generate test matrix dynamically by dividing spec files into buckets
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
        
      - name: Generate test matrix
        id: set-matrix
        run: |
          ruby generate-test-matrix.rb | tee /dev/stderr | jq -c '.' | xargs -I {} echo "matrix={}" >> $GITHUB_OUTPUT
          
      - name: Upload test bucket files
        uses: actions/upload-artifact@v4
        with:
          name: test-buckets
          path: test-bucket-*.txt

  # Build the Docker image and save it as an artifact
  build:
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Cached LFS checkout
        uses: nschloe/action-cached-lfs-checkout@v1.2.3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha
            
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            trimmed=false

  # Test jobs that run in parallel using the built image
  test:
    needs: [build, generate-matrix]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    
    env:
      COMPOSE_FILE: docker-compose.yml:docker-compose.ci.yml
          
    steps:
      - name: Cached LFS checkout
        uses: nschloe/action-cached-lfs-checkout@v1.2.3

      - name: Download test bucket files
        uses: actions/download-artifact@v4
        with:
          name: test-buckets

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tag
        id: image
        run: echo "tag=$(echo '${{ needs.build.outputs.image-tags }}' | head -n1)" >> $GITHUB_OUTPUT

      - name: Fix permissions for bind mounts
        run: |
          # Ensure all repository files are owned by baw_web (UID 1000) so containers can access them
          sudo chown -R 1000:1000 .
          
      - name: Start services
        env:
          CI_IMAGE: ${{ steps.image.outputs.tag }}
        run: |
          echo "Using image: $CI_IMAGE"
          docker compose --profile test up --detach --wait --timeout 120
          
      - name: Debugging
        env:
          CI_IMAGE: ${{ steps.image.outputs.tag }}
        run: |
          docker compose ps
          docker ps
        if: ${{ always() }}

      - name: Run bucket ${{ matrix.bucket }} tests
        env:
          CI_IMAGE: ${{ steps.image.outputs.tag }}
        run: |
          # Copy test file list to container
          docker cp test-bucket-${{ matrix.bucket }}.txt $(docker compose ps -q web):/home/baw_web/baw-server/test-files.txt
          
          # Install test dependencies and run tests using the file list
          docker compose exec -T web bash -c '
            # Ensure test dependencies are installed
            bundle install --with test
            
            if [ -f /home/baw_web/baw-server/test-files.txt ]; then
              # Run tests and capture exit code
              cat /home/baw_web/baw-server/test-files.txt | xargs rspec --format progress --format html --out rspec_results_bucket_${{ matrix.bucket }}.html
              TEST_EXIT_CODE=$?
              
              # If tests failed, retry only the failed tests
              if [ $TEST_EXIT_CODE -ne 0 ]; then
                echo "::warning::Tests failed on first attempt, retrying only failed tests..."

                rspec --only-failures --format progress --format html --out rspec_results_bucket_${{ matrix.bucket }}_retry.html
                RETRY_EXIT_CODE=$?
                
                if [ $RETRY_EXIT_CODE -eq 0 ]; then
                  echo "::notice::Tests passed on retry - possible flaky tests in bucket ${{ matrix.bucket }}"
                fi
                
                # Exit with the retry exit code
                exit $RETRY_EXIT_CODE
              fi
              
              exit $TEST_EXIT_CODE
            else
              echo "No test files found for bucket ${{ matrix.bucket }}"
              exit 1
            fi
          '

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rspec-test-results-bucket-${{ matrix.bucket }}
          path: rspec_results_bucket_${{ matrix.bucket }}*.html

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-logs-bucket-${{ matrix.bucket }}
          path: log/*test.log

      - name: Stop services
        env:
          CI_IMAGE: ${{ steps.image.outputs.tag }}
        if: always()
        run: docker compose down

  # Push release with version, changelog, docs, tag, and image (only on master branch and tags)
  push:
    needs: [build, test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || contains(github.ref, 'refs/tags/'))

    env:
      COMPOSE_FILE: docker-compose.yml:docker-compose.ci.yml

    steps:
      - name: Cached LFS checkout
        uses: nschloe/action-cached-lfs-checkout@v1.2.3
        with:
          fetch-depth: 200

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tag
        id: image
        run: echo "tag=$(echo '${{ needs.build.outputs.image-tags }}' | head -n1)" >> $GITHUB_OUTPUT

      - name: Calculate git describe
        id: tagger
        shell: pwsh
        run: |
          $result = @( git fetch --prune && git describe 'HEAD~' )
          $last_line = $result[-1]
          if ([string]::IsNullOrWhiteSpace($last_line)) {
            Write-Output "failed to get git describe, result was: $result"
            exit 1
          }
          echo "tag=$last_line" >> $env:GITHUB_OUTPUT

      - name: Fix permissions for bind mounts
        run: sudo chown -R 1000:1000 .

      - name: Start services
        env:
          CI_IMAGE: ${{ steps.image.outputs.tag }}
        run: docker compose --profile test up --detach --wait --timeout 120

      - name: Generate changelog
        env:
          CI_IMAGE: ${{ steps.image.outputs.tag }}
          CHANGELOG_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: docker compose exec -T web rake changelog

      - name: Generate API docs
        env:
          CI_IMAGE: ${{ steps.image.outputs.tag }}
        run: docker compose exec -T web generate_docs.sh

      - name: Stop services
        env:
          CI_IMAGE: ${{ steps.image.outputs.tag }}
        if: always()
        run: docker compose down

      - name: Set VERSION and commit changes
        run: |
          echo "${{ steps.tagger.outputs.tag }}" > VERSION
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Generated changelog and API docs for version ${{ steps.tagger.outputs.tag }}" -m "[skip ci]"

      - name: Create and push tag
        run: |
          git tag -a -m "Version ${{ steps.tagger.outputs.tag }}" "${{ steps.tagger.outputs.tag }}"
          git push --follow-tags

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: atruskie
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push to DockerHub
        uses: docker/build-push-action@v5
        with:
          build-args: |
            trimmed=true
            version=${{ steps.tagger.outputs.tag }}
          context: .
          push: true
          tags: qutecoacoustics/workbench-server:${{ steps.tagger.outputs.tag }},qutecoacoustics/workbench-server:latest
          labels: |
             version=${{ steps.tagger.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
